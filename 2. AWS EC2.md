# 2. AWS SSA EC2
###### tags: `aws` `aws-saa`

## EC2

### Budget setup
1. Bill infomation need to been activated the permission.
2. It can be setted budgets and alert(by threshold).

### Basic
1. ec2 user-data: input a script, it will run when frist launch.

### EC2 InstanceType
1. computing optimized: computing optimized
2. memory optimized: for ex. web sever, cache, BI...
3. Storage optimized: for sql, nosql, cache

### Security Groups
1. only contain allow rules.
2. all inbound traffic is blocked default.
3. all outbound traffic is authorised by default.

### Purchasing Options
1. On-Demand Instances
    1. short workloads, predictable pricing
    2. billing per second
2. Reserved 
    1. minimum 1 year
    2. three type
        - Reserved Instances: long workloads(etc. database)
        - Convertible Reserved Instances: long workloads with flexible instanses (instanses type can be changed, upto 54% discount)
        - Scheduled Reserved Instances: every day between 3 and 6pm
    3. Up to 75% discount compared to On-demand
    4. purchasing options: no upfront| partial upfront| All upfront = ++ discount
3. Spot Instances
    1. short workloads, cheap, can lose instances(less reliable)
    2. the greatest discount, up to 90% compared to On-demand
    3. you can lose at any point of time, if your max price is less than the current spot price
    4. Use for workloads that are resilient to failure
        - Batch jobs
        - Data analysis
        - Image processing
        - Any distributed workloads
    5. Not suitable for critical jobs or database
4. Dedicated Host:
    1. book an entire physical server, control instance placement
    2. can help you address compliance requirements and reduce costs by allowing you to use your exising server-bound software licenses.
    3.  Allocated for your  account for a 3-year period reservation
    4.  More expensive
    5.  Useful for software that complicated licensing model(BYOL-Bring Your Own License)
    6.  Or for companies that have strong regulatory or compliance needs
5. Dedicated Instances
    1. Instances running on hardware
    2. May share hardware with other instances in same account
    3. No control over instance placement(can move hardware after Stop/Start)

#### How to terminate Spot Instances
![](https://i.imgur.com/NsxHygN.png)

#### Spot Fleet
1. set of Spot Instances + (optinal) On-Demand Instances
2. LowestPrice: from the pool with the lowest price


## Placement Groups

### Cluster
1. it's in the same availability groups, same hardware.
2. hight performance, high risky(all the instances will fail at the same time)
3. Use cases
    - Big Data job that needs to complete faset.
    - Application that needs extremely low latency and high network throughput.

### Spread
1. Can span across AZ
2. Reduced risk is simultaneous failure
3. Limited to "7 instances" per placement groups
4. Use cases
    - Application that needs to maximize high availability

### Partition
1. Up to 7 partitions per AZ
2. Can span across multiple AZs in the same region
3. Up to 100s of EC2 instances
4. The instances in a partition do not share racks with the instances in the other partitions
5. A partition failure can affect many EC2 but won't affect other partitions
6. Use cases
    - HDFS
    - HBase
    - Cassandra
    - Kafka

## Elastic Network Interfaces (ENI)
1. Logical component in a VPC that represents a virtual network card
2. The ENI can have the following attributes:
    - Primary private IPv4, one or more secondary IPv4
    - One Elastic IP(IPv4) per private IPv4
    - One           Public IPv4 
    - One or more security groups
    - a MAC address
3. You can create ENI independently and attach them on the fly(move them) on EC2 instances for failover
4. Bound to a specific AZ (can be move on different instances)

## EC2 Hibernate
1. Stop instances: the data on disk(EBS) is kept intact in the next start
2. Terminate: any EBS volumes(root) also set-up to be dstroyed is lost
3. *Hibernate*: 
    - The in-memory(RAM) state is preserved
    - The instance boot is much faster(the Os is not stopped/restart)
    - Under the hood: the RAM state is written to a file in the root EBS volume
    - The root EBS volume must be encrypted
    - Use cases
        - long-running processing
        - saving the RAM state
        - services that take time to initialize

### Good to know
1. Supported instance families - C3, C4, C5, M3, M4, M5, R3, R4 and R5
2. Instance RAM size - must be less than *150 GB*
3. Instance size - not supported for bare metal instances
4. AMI: Amazon Linux2, Linux AMI, Ubuntu ...& *Windows*
5. Root Volume: must be *EBS*, encrypted, not instance store, and large
6. Available for On-Demand and Reserved Instances
7. An instance can't be hibernate more than *60 days*

### EC2 Nitro
1. Underlying Platform for the next generation of EC2 instances
2. New virtualization technology
3. Allow for better Performance
    - Better networking options(echanced networking, HPC, IPv6)
    - Hight Speed EBS(Nitro is necessary for 64,000 EBS IOPS - max 32,000 on non-Nitro)
4. Better underlying security
5. Instance type exmaple:
    - Virtualized: A1, C5, C5a, C5ad, C5d, C5n, C6g, D3, D3en, G4, I3en, Infl, M5, M5a........
    - Bare metal: a1.metal, c5.metal, c5d.metal......

### EC2 vCPU
1. Example: m5.2xlage
    - 4CPU
    - 2 threads per CPU
    - => 8 vCPU in total

### EC2 Capacity Reservations
1. Capacity Reservations ensure you have EC2 Capacity when needed
2. Manual or planned end-date for the reservation
3. No need for 1 or 3-year commitment
4. Capactiy access is immediate, you get billed as soon as it starts
5. Specify:
    - The AZ in which to reserve the capacity(only one)
    - The number of instances for which to reserve capacity
    - The instance attributes including the instance type, tenancy and platform/Os
6. Combine with Reserved Instances and Saving Plns to do cost saving 

## EC2 Storage 

### EBS Volume
1. They are a network drive you can attach to your instances while they run.
    - It uses the network to communicate the instance, might be a bit latency.
    - It can be detached from an EC2 instance and attached to another one quicky.
3. It allows your instance to persist data, even after their termaination.
4. They can only be mounted to one instance at a time(at the CCP Level).
5. They are bound to a specific AZ.
    - To move a volume across, you first need to snapshot it.
7. Analogy: Think of them as a "network USB stick".
8. Free tier: 30 GB of free EBS storage of type General Purpose(SSD) or Magnetic per month.
9. Have a provision capacity(size in GBs, and IOPS)
    - You get billed for all the provision capacity.
    - You can increase the capacity of the drive over time.
10. Delete on Termaination attribute
    - Controls the EBS behaviour when EC2 instace terminate
        - By default, the root EBS volume is deleted(attribute enabled)
        - By defalut, any other attached EBS volume is not deleted(attribute disable)
    - This can be controlled by the AWS console/ AWS CLI.

### EBS Snapshot
1. Make a backup(snapshot) of your EBS volume a point in time.
2. Not necessary to detach volume to do snapshot, but recommended.
3. Can "copy" snapshot across AZ or Region.
4. Can use a shotshot to create a new EC2 instance.

## AMI 

### AMI Overview
1. AMI = Amazon Machine Image.
2. AMI are a customization of an EC2 instace.
    - You add your own software, configuration, operation system, monitoring...
3. AMI are built for a specific region(an can be "copied " acorss regions)
4. You can launch EC2 instances from
    - A public AMI: AWS provided.
    - Your own AMI: ypu make an maintain them by yourself.
    - An AWS Marketplace AMI: an AMI someone else made(an potentially sells).

### AMI Process(from an EC2 instance)
1. Start an EC2 instance and customize it.
2. Stop the instance(for data integrity).
3. Build an AMI - this will also create EBS snapshot.
4. Launch instances from other AMIs.
 
 ## EC2 Instance Store
 1. It's real hardware connected to server.
 2. Better I/O than EBS
 3. EC2 Instance Store lose their storage if they're stopped(ephemeral)
 4. Good for buffer/ cache/ scratch data/ temporary content
 5. Risk of data loss if hardware fail
 6. Backups and Replication are your responsibity
 
 ## EBS Volume Type 
 1. EBS Volumes come in 6 Types
     1. gp1/ gp2 (SSD): general pupose SSD,balances price and performacnce for a wide variety of workloads.
     2. io1/ io2 (SSD): highest-performance for mission-critical low-latency or high-throughput workloads.
     3. st1 (HDD): low cost HDD volume designed for frequently accessd, throughput-intensive work loads.
     4. sc1 (HDD): lowest cost HDD volume for less frequently accessed workloads.
  2. Only gp2/gp3 and io1/io2 can be used as boot volumes.

  ## EBS Volume Types Use cases
  
  ### General Pupose
  1. Cost effective storage, low-latency
  2. System boot volumes, Virtual desktop, Development and test environments.
  3. 1 GiB - 16GiB
  4. gp3: 
      - Baseline of 3,000 IOPS and throughput of 125MiB/s
      - Can increase IOPS up to 16,000 and throughtput up to 1000 MiB/s **independently**
  5. gp2:
      - Small gp2 volumens can burst IOPS to 3,000
      - Size of the volume an IOPS are **linked**, max IOPS is 16,000
      - 3 IOPS per GB, means at 5334 GB are at the Max IOPS

   ### Provisioned IOPS (PIOPS) SSD
   1. Critical business applications with sustained IOPS performance
   2. Or application that need more than 16,000 IOPS
   3. Great for database workloads (sensitive to storage perf and consistency)
   4. io1/io2 (4GiB - 16 GiB)
       - Max PIOPS: 64,000 for **Nitro** EC2 instances & 32,000 for other
       - Can instances PIOPS **independently** from storage size
       - io2 have more durability and more IOPS per GiB(at the same price as io1)
   5. io2 Block Express (4 GiB - 64TiB)
       - Sib-millisecond latency
       - Max PIOPS: 256,000 with an IOPS:GiB ratio of 1,000: 1
   6. Supports EBS Multi-attach 
   
   ### Hard Disk Drives (HDD)
   1. **Can't be boot volume**
   2. 125 MiB to 16TiB
   3. Throughput Optimized HDD (st1)
       - Big Data , Data Warehouses, Log Processing
       - Max throughput 500Mib/s - max IOPS 500
   4. Cold HDD (sc1)
       - For data that infrequently accessed
       - Senarios where lowest cost in important
       - Max throughput 250 MiB/s - max IOPS 250
   ### Summary

   ![](https://i.imgur.com/QrTZ5Mi.png)
 
   ### EBS Mulit-Attach - Only for io1/io2 family
   1. Attach the same EBS volume to multiple EC2 instance in the same AZ
   2. Each instance has full read & write permissions to the volume
   3. Use case:
        - Achieve higher application availability in clustered Linux applications (ex: Teradata)
        - Applications must manage concurrent write operations
    4. Must use a file system that's cluster-aware(not XFS, EX4, etc....)

  ## EBS Ecryption
  1. When you create an encrypted EBS volumns, you get the following:
        - Data at rest is an encrypted inside the volume
        - All the data in flight moving between the instance and the volumn is encrypted
        - All snapshots are encrypted
        - All volumes created from the snapshot
  2. Encryption and decryption are handled transparently (you have nothing to do)
  3. Encryption has a minimal impact on latency
  4. EBS Encryption leverages keys from KMS(AES-256)
  5. Copying an unencrypted snapshot allows encryption
  
  ## EFS - Elastic File System
  1. Use cases: content management, web serving data sharing Wordpress
  2. Uses NFSv4.1 protocol
  3. Uses security group to control access to EFS
  4. Compatitle with **Linux** base AMI (not Windows)
  5. Encryption at rest usung KMS
  6. POSIX file system (~Linux) that has a standard file API
  7. File system scales automatically, pay-per-use, no capacity planning
  
  ### EFS - Performance & Storage Classes
  1. EFS Scale
        - 1000s of concurrent NFS clients, 10 GB+/s throughput
        - Grow to Petabyte-scale network file system, automatically
  2. Perfomance mode (set at EFS creation time)
        1. General purpose(default): latency-senstive use case(web server, CMS, etc...)
        2. Max I/O - higher latency, throught, highly parallel (big data, media processing)
  3. Throughput mode
        1. Bursting(1TB = 50MiB/s + burst of up to 100MiB/s)
        2. Provisioned: set your throughput regardless of storage size, ex 1GiB/s for 1TB storage
  3. Store Tiers(lifecycle management feature - move file after N days)
        1. Standard: for frequently accessed file
        2. Infrequent access(EFS-IA): cost to retrieve files, lower price to store