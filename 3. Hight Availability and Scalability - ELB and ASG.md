# 3. Hight Availability and Scalability: ELB & ASG
###### tags: `aws` `aws-saa`

## Elastic Load Balancing (ELB)

### Why use a load balancer?
1. Sperad load across multiple downstream instances
2. Expose a single point of access(DNS) to your application
3. Seamlessly handle failures of downstream instances
4. Do regular health checks to your instanses
5. Provide SSL termination (HTTPS) for your websites
6. Enforce stickiness with cookies
7. High availability across zones
8. Separate public traffic from private traffic
9. An Elastic Load Balancer is managed load balancer
    - AWS guarantees that will be working
    - AWS take care of upgrades, maintenance, high avabilability
    - AWS provides only a few configuration knobs
10. It costs less to setup own load balancer, but it will be a more effort on your end
11. It interated with many AWS offerings/ services
    - EC2, EC2 Auto Scaling Groups; Amazon ECS
    - AWS Certificate Manager(ACM), CloudWatch
    - Route 53, AWS WAF, AWS Global Accelerator

### Health Check 
1. It check is done on a port and a rout(/health is common)

### Type of balacner on AWS
AWS has 4 kinds of managed Load Balancers
1. Classic Load Blanacer(v1 - old generation) - 2009 - CLB (been deplayed abandon, but still choiceable)
    - HTTP, HTTPS, TCP, SSL (secure TCP)
    - Doesn't support IPv6
2. Application Load Balancer (v2 - new generation) - 2016 -ALB
    - HTTP, HTTPS, WebSocket
3. Network Load Blancer(v2 - new generation) - 2017 - NLB
    - TCP, TLS（secure TCP）, 
4. Gateway Load Balancer - 2020 - GWLB
    - Operates at layer 3 (Network layer) - IP Protocol

- Overall, it is recommended to use the new generation load balancers as they provide more feature
- Some load balancer can be setup as internal(private) or external(public) ELBs

### Class Load Balancer(v1)
1. Supports TCP(Layer 4), Http & Https(Layer 7)
2. Health checks are TCP/Http base
3. Fixed hostname
    XXX.region.elb.amazonaws.com
    
### Application Load Balancer (v2)
1. Application load balancer is Layer 7(Http)
2. Load balancing to multiple applicationss across machines(target groups)
3. Load balancing to multiple applications on the same machine (ex: containers)
4. Support for Http/2 and WebSocket
5. Support redirects(from Http to Https for example)
6. Routing tables to different target groups:
    - Routing based on path in URL(example.com/user & example.com/posts)
    - Routing based on hostname in URL(one.example.com & other.example.com)
    - Routing based on Query String,Headers (example.com/user?id=123&order=false)
7. ALB are a great fit for micro services & container-based application(example: Docker & Amazon ECS)
8. Has a port mapping feature to redirect to dynamic port in ECS
9. In comparison, we'd need multiple Classic Load Balancer per application

#### Target Groups
1. EC2 instances (can be managed by an Auto Scaling Group) - Http
2. EC2 tasks (managed by ECS itself) - Http
3. Lambda functions - Http request is translated into a Json event
4. IP Addresses - must be **private IPs**
5. ALB can route to multiple target groups
6. Health checks are at the **target group** level

#### Good to know
1. Fixed hostname
2. The application servers don't see the IP of the client directly
    - The true IP of the client is inserted in the header X-Forwarded-For
    - We can also get Port (X-Forwarded-Port) and proto(X-Forwarded-Proto)

### Network Load Balancer(v2)
1. Network load balancers(Layer 4) allow to:
    - Forward TCP & UDP traffic to your instances
    - Handle millions of request per seconds
    - Less latency ~100ms (vs 400ms for ALB)
2. NLB has one static IP per AZ, and supports assigning Elastic IP (helpful for whitelisting specific IP)
3. NLB ar used for extreme performance, TCP or UDP traffic 
4. **Not included** in the AWS free tier

#### Target Group
1. EC2 instances
2. IP Addresses - must be **private IP**
3. Application Load Balancer

### Gateway Load Balancer
1. Deploy, scale, and manage a fleet of 3rd Party network virtual applicances in AWS
2. Example: Firewalls, intrusion Detection and Preventio  Systems, payload manipulatuin,...
3. Operates at **Layer 3 (Network Layer)** - IP Packets
4. Combines the following functions:
    - Transparent Network Gateway - single entry/exit for all traffic
    - Load Balancer - distributes traffic to your virtual appliances
5. Use the **GENEVE** protocl on **6081**

    ![](https://i.imgur.com/jHhSI5v.png)

### Sticky Sessions  (Session Affinity)
1. It is possible to implement stickiness so that same client is aways redirected to the same instance behind a load balancer
2. This works for Class Load Balancers & Application Load Balancers
3. The **cookied** used for stickiness has an expiration date you control
4. Use case: make sure the user doesn't lose his session data
5. Enabling stickiness may bring imbalance to the over the backend EC2 instances

### Cookie Name
1. Application-based Cookies
    1. Custom cookie
        - Generated by the **target**
        - Can include any custom attributes required by the application
        - Cookie name must be specified individually for each target group
        - Don't use AWSALB, AWSALBAPP, or AWSALBTG (reserved for use by the ELB)
    2. Application cookie
        - Generated by the **load balancer**
        - Cookie name is AWSALBAPP
2. Duartion-based Cookied
    1. Cookie generated by the **load balancer**
    2. Cookie name is AWSALB for ALB AWSELB for CLB

### Cross-Zone Load Balancing
![](https://i.imgur.com/TWGx999.png)
- Application Load Balancer
    - Always on(can't be disabled)
    - No charges for inter AZ data
- Network Load Balancer
    - Disabled by default
    - You pay charges ($) for inter AZ data if enable
- Classic Load Balancer
    - Disabled by default
    - No charges for inter AZ data if enable

### Load Balancer - SSL Certificates
![](https://i.imgur.com/f15gSkx.png)
1. The load balancer use an X.509 certificate (SSL/TLS server cerificate)
2. You can manage certificates using ACM (AWS Certificate Manager)
3. You can create upload your own certificates alternatively
4. Https listener:
    - You must specify a default certificate
    - You can add an optional list of certs to support multiple domains
    - Clients Can us **SNI** (Server Name Indication) to specify the hostname they reach
    - Ability to specify a security policy to support older versions of SSL/TSL (legacy clients)

#### SSL SNI - Server Name Indication 
1. SNI solves the problem of loading multiple SSL certificates onto one web server (to serve multiple websites)
2. It's a **newer** protocol, and requires the client to indicate the hostname of target group server in the initial SSL handshake
3. The server will then find the correct certificate, or return the default one.
4. Only works for ALB & NLB (newer generation), CloudFront
5. Does not work for CLB (older gen)
![](https://i.imgur.com/SWldqNU.png)
 
### Connection Draining
1. Feature naming 
    - Connection Draining - for CLB
    - Deregistration Delay - for ALB & NLB
2. Time to complete **in-flight requests** while the instance is de-registering or unhealty
3. Stops sending new requests to the EC2 instance which is de-registering
4. Between 1 to 3600 seconds (default: 300)
5. Can be disable(set value to 0)
6. Set to a low value if your requests are short

## Auto Scaling Group in AWS (ASG)
### ASGs has the following attributes
1. A launch configuration
    - AMI + Instance Type
    - EC2 User Data
    - EBS Volumnes
    - Security Group
    - SSH key Pair
2. Min Size/ Max Size/ Inital Capacity
3. Network + Subnets Information
4. Load Balancer Information
5. Scaling Policies 

### Auto Scaling Alarms
1. Base on CloudWatch alarms
2. An Alarm monitors a metric (such as Average CPU)
3. Metrics are computed for the overall ASG Instances

### Auto Scaling New Rules 
1. It is now possible to define "better" auto scaling rules that are directly
    - Target Average CPU Usage
    - Number of requests on the ELB instance
    - Average Network In
    - Average Network Out

### ASG Brain Dump
1. ASGs use Launch configurations or Launch Templates(newer)
2. To update an ASG, yoou must provide a new launch configuration / launch template
3. IAM roles attached to ASG will get assigned to EC2 instances
4. ASG are **free**. You pay for the underlying resources being launched
5. Having instances under an ASG means that if they get terminated for whatever reason, the ASG will automatically create new ones as a replacement.
6. ASG can terminate instances marked as unhealthy by an LB (and hence replace them

### Dynamic Scaling Policies
1. Target Tracking Scaling
    - Example: I want the avgerage ASG CPU to stay at around 40%
2. Simple / Step Scaling
    - When a CloudWatch alarm is triggered (Example CPU > 70%), then add 2 units
    - When a CloudWatch alarm is triggered (Example CPU < 30%), then remove 1
3. Scheduled Actions
    - Anticipate a scaling base on know usage patterns

### Predictive Scaling
1. Predictive scaling: continuously forecast load and schedule scaling ahead
![](https://i.imgur.com/bcK14gc.png)

### Good metrics to scale on
1. CPUUtilization
2. RequestCountPerTarget
3. Average Nework In/Out (if your application is network bound)
4. Any custon mertic

### Scaling Cooldown
1. After a scaling activity happens, you are in the cooldown period (default 300 seconds)
2. During the cooldown period, the ASG will not launch or terminate additional instancse(to allow for metric to stabilize)
3. Advice: Use a ready-to-use AMI to reduce configuration time in order to be serving request fasters and reduce the cool down period

## ASG for Solutions Architects
### ASG Default Termination Policy (simplified versions):
1. Find the AZ which has the most number of instances
2. If there are multiple instances in the AZ to choose from, delete the one with the **oldest** launch configuration

> ASG tries the balance the number of instances across AZ by Default
> ![](https://i.imgur.com/ECW5aqJ.png)

### Lifecycle Hooks
1. By default as soon as an instance is launched in ASG it's in service
2. You have the ability to perform extra steps before the instance goes in service(Pending state)
3. You have the ability to perform some actions before the instance is terminated(Terminating state)

![](https://i.imgur.com/bQAdTyY.png)

### Launch Template vs Launch Configuration
- Both:
    - ID of the Amazon Machine Image (AMI), the instance type, a key pair, security groups, and the other parameters that you use to launch EC2 instance(tags, EC2 user-data)
- Launch Configuration (**legacy**)
    - Must be re-created every time
- Launch Template (**newer**)
    - Can have multiple versions
    - Create parameters subsets (partial configuration for re-use and inheritance) 
    - Provsion using both On-Demand and Spot instances(or a mix)
    - Can use T2 unlimited burst feature
    - **Recommended by AWS going forward**