# 4. AWS RDS
###### tags: `aws` `aws-saa`

## RDS Overview
1. RdS stands for Relational Database Service
2. It;s a managed DB service for DB use SQL and query language
3. It allows you to create databases in the cloud that are managed by AWS
    - Postges
    - MySQL
    - MariaDB
    - Oracle
    - MSSql
    - Aurora (AWS Proprietary database)

### Advantage over using RDS versus deploying DB  on EC2
1. RDS is a managed service:
    - Automated provisioning, OS patching
    - Continuous backups and restore to specific timestamp (Point in Time Restore)
    - Monitoring dashboards
    - Read replicas for imporved read performance 
    - Multi AZ setup for DR(Disaster Recovery)
    - Maintenance windows for upgrades
    - Scaling capability (vertical and horizontal)
    - Storage backed by EBS(gp2 or io1)
2. But you can't SSH into instance

### RDS Backups
1. Backups are automatically enabled in RDS
2. Automated backups:
    - Daily full backup(during the maintenance window)
    - Transaction logs are back-up by every 5 mins
    - 7 days retention (can be increased to 35 days)
3. DB Snaphots
    - Manually triggered by user
    - Retention of backup for as long as you want 

### RDS - Storage Auto Scaling
1. Help you increase storage on your RDS DB instance dynamically
2. When RDS detects you are runing out of free database storage, it scales automatically
3. Avoid manually scaling your database storage
4. You have to set Maximum Storage Threshold(maximum limit for DB storage)
5. Automatically modify storage if:
    - Free storage is less than 10% of allocated storage
    - Low-storage lasts at 5 mins
    - 6 hours have passed since last modification
6. Useful for applications with unpredictable workloads 
7. Supports all RDS database engines

## RDS Read Replica for read scalability
1. Up to 5 Replicas
2. Within AZ, Cross AZ or Cross Region
3. Replication is **ASYNC**, so reads are eventually consistent
4. Replicas can be promoted to their own DB
5. Applications must update the connection string to leverage read replicas

### RDS Read Replicas - Network Cost
1. In AWS there's a network cost when data goes from on AZ to another
2. For RDS Read Replicas within the same region, you don't pay that fee

### RDS Multi AZ (Disaster Recovery)
1. **SYNC** replication
2. One DNS name - automatic app failover to standy
3. Increase **availability**
4. Failover in case of loss of AZ, loss of network, instance or storage failure
5. No manual intervention in apps
6. No use for scaling
7. **Note:** The Read Replicas can setup as Multi AZ for Disaster Recovery(DR)

### RDS - From Single-AZ to Multi-AZ
1. Zero downtime operation (no need to stop the DB)
2. Just click on "modify" for the DB
3. The following happens internally
    1. A snapshot is taken
    2. A new DB is restored from the snapshot in new AZ
    3. Synchronization is established between the two DBs

## RDS Security - Encryption
1. At rest encryption
    1. Possibility to encrypt the master & read replicas with AWS KMS - AES-256 encryption
    2. Encryption has o be defined at launch time
    3. **If the master is not encrypted, the read replicas __cannot__ be encypted**
    4. Transparent Data Encryption(TDE) available for Oracle and SQL Server
2. In-flight encryption
    1. SSL certificates to encrypt data to RDS in flight
    2. Provide SSL options with trust certificate when connecting to database
    3. To enforce SSL:
        - PostgreSQL: rds.force_ssl=1 in the AWS RDS Console(Parameter Groups)
        - MySQL: Within the DB:
            ```
                GRANT USAGE ON *.* TO 'mysqluser'@'%' REQUIRE SSL;
            ```

### RDS Encryption Operations
1. Encrypting RDS backups
    1. Snapshot of un-encrypted RDS databases are un-encrypted
    2. Snapshot of encrypted RDS databases are encrypted
    3. Can copy a snapshot into an encrypted one
2. To encrypt an un-encrypted RDS database:
    1. Create a snapshot of the un-encrypted database
    2. Copy the snapshot and enable encryption for the snapshot
    3. Restore the db from the encrypted snapshot
    4. Migrate applications to the new db, and delete the old db

### RDS Security - Network & IAM
1. Network Security
    1. RDS database are usually deployed within a private subnet, not in a public one
    2. RDS security work by leveraging sercurity groups(the same concept as for EC2 instances) - oit controls with IP/security group can communicate with RDS
2. Access Management
    1. IAM policies help control who can manage AWS RDS(through the RDS API)
    2. Traditional Username and Password can be used to login into the database
    3. IAM-based authentication can be used to login into RDS MySQL&PostgreSQL

#### RDS - IAM Authentication
1. IAM db authentication works with MySQL and PostgreSQL
2. You don't need a password, just an authentication token obtained through IAM & RDS API calls
3. Auth token has a lifetime of **15 mins**
4. Benefits:
    - Network in/out must be encrypted using SSL
    - IAM to centrally manage users instead of DB
    - Can leverage IAM Roles and EC2 isntance profiles for easy integration

### RDS Security - Summary

![](https://i.imgur.com/ZcqQmdY.png)

## Amazon Aurora
1. Aurora is proprietary technology from AWS(not open sourced)
2. Postgres and MySQL are both supported as Aurora DB(that means your drivers will work as if Aurora was a Postgres or MySQL db)
3. Aurora is "AWS cloud optimized" and claims 5x performance improvement over MySQL on RDS, over 3x the performance of Postgres on RDS
4. Aurora storage automatically grows in increments of 10GB, up to 128 TB.
5. Aurora can have 15 relicas while MySQL has 5, and the replication process is faster (sub 10 ms replica lag)
6. Failover in Aurora is instantaneous. It's HA native
7. Aurora costs more than RDS(20% more) - but is more efficient

### Aurora High Availability and Read Scaling
1. 6 copies of your data across 3 AZ:
    - 4 copies out of 6 needed for writes
    - 3 copies out of 6 need for reads
    - Self healing with peer-to-peer replication
    - Storage is striped across 100s of volumes
2. One Aurora Instance takes writes (master)
3. Automated failover for master in less than 30s
4. Master + up to 15 Aurora Read Replicas serve reads
5. Support for Cross Region Replication
![](https://i.imgur.com/kyt0luj.png)
6. Read Replicas Load Balancing on **connection levels**, not on statement level
### Aurora DB Cluster
![](https://i.imgur.com/gvuWGfa.png)

### Feature of Aurora
- Automatic fail-over
- Backup and Recovery
- Isolation and security
- Industry compliance
- Push-button scaling
- Automated Patching with zero downtime
- Advanced Monitoring
- Routine Maintenacnce
- Backtrack: restore data at any point of time without using backups

### Aurora Security
 ![](https://i.imgur.com/G1B7rJa.png)
 
## Aurora Replicas 

### Aurora Replicas - Auto Scaling

![](https://i.imgur.com/dGIaw0h.png)

### Aurora - Custom Endpoints
- Define a subset of Aurora Instances as Custom Endpoint
- Example: Run analytical queries on specific replicas
- The Reader Endpoint is generally not used after defining Custom Endpoints(but still existed)

![](https://i.imgur.com/WeC7IJS.png)

### Aurora Serverless
- Automated database instantiation and auto-scaling based on actual usage
- Good for infequent, intermittent or unpredictable workloads
- No capacity planning needed
- Pay per second, can be more cost-effective
![](https://i.imgur.com/m4VpGw1.png)

### Aurora Multi-Master
- In case you want immediate failover for write node(HA)
- Every node does R/W - vs promoting a RR as the new mater

### Global Aurora
- Aurora Cross Regin Read Replicas:
	- Useful for disaster recovery
	- Simple to put in place
- Aurora Global Database (recommended):
	- 1 primary region(read/write)
	- Up to 5 secondary(read-only) regions, replication lag is less than 1 second
	- Up to 16 Read Replicas per secondary region
	- Helps for decreasing latency
	- Promoting another region (for disaster recovery) has an RTO of < 1 min

### Aurora Machine Learning
- Enables you to add ML-based predictions to your applications via SQL
- Simple, optimzed, and secure integration between Aurora and AWS ML service
- Supported services 
	- Amazon SageMaker (use with any ML model)
	- Amazon Comprehend (for sentiment analysis)
- You don't need to have ML experience
- Use cases: fraud detection, ads targeting, sentiment analysis, product recommendations

## Amazon ElastiCache 
### Overview
- The same way RDS is to get managed Relational Database
- ElastiCache is to get managed Redis or Memcached
- Help make your application stateless
- AWS take care of OS maintenance/ patching, optimizations, setup, configuration, monitoring, failure recovery and backups
- Using ElastiCache involves heavy application code changes

### ElastiCache Solution Architecture - User Session Store
![](https://i.imgur.com/j8OjUHb.png)

### Redis vs Memcached
1. Redis
	- Multi AZ with Auto-Failover
	- Read Replicas to scale reads and have high availability
	- Data Durability using AOF peristence
	- Backup and restore features
2. Memcached
	- Multi-node of partitioning of data (sharding)
	- No high availability (replication)
	- Non persistent
	- No backup and restore
	- Multi-threaded architecture

### hands on
- Security 
	- if checked Encryption in-transit, you can set redis auth to your applications
![](https://i.imgur.com/dXaNwfw.png)

### ElastiCache - Cache Sercurity
- All caches in ElastiCache:
	- __**Do not support IAM authentication**__
	- IAM policies on ElastiCache are only used for AWS API-level security
- Redis AUTH
	- You cant set a "password/token" when you create a Redis cluster
	- This is an extra level of sercurity for your cache
	(on top of security groups)
	- Support SSL in flight encryption
- Memcached 
	- Supports SASL-based authentication (advanced)

### Patterns for ElastiCache
- Lasy Loading:
	- all the read data is cached, data can become stale in cache
- Write Through: 
	- Adds or update data in the cache when written to DB (no stale data)
- Session Store: 
	- store temporary session data in a cache (using TTL feature)

### ElastiCache - Redis Use Case
1. Gaming Leaderborads are computationally complex
2. __**Redis Sorted sets**__ gurarantee both uniqueness and element ordering
3. Each time a new element added, it's ranked in real time, then added in correct order

### List of Ports to be familiar with 
Important ports:
- FTP: 21
- SSH: 22
- SFTP: 22